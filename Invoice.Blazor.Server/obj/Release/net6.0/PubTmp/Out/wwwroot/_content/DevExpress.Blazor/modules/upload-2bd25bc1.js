import{D as e}from"./dom-166a04be.js";import{D as t}from"./dx-html-element-base-7f87ceb0.js";import{C as s}from"./custom-events-helper-18f7786a.js";import"./_tslib-6e8ca86b.js";import"./data-qa-utils-8be7c726.js";import"./dx-html-element-pointer-events-helper-0f2b6602.js";import"./eventhelper-8570b930.js";class i{constructor(e){this.files=e}}class a{constructor(e){this.request=e}}class o{constructor(e){this.progress=e}}class r{constructor(e){this.requestOptions=e}}class n extends CustomEvent{constructor(e){super(n.eventName,{detail:new i(e),bubbles:!0,composed:!0})}}n.eventName="dxbl-upload.filesadded",s.register(n.eventName,(e=>e.detail));class l extends CustomEvent{constructor(e){super(l.eventName,{detail:new a(e),bubbles:!0,composed:!0,cancelable:!0})}}l.eventName="dxbl-upload.actionrequest",s.register(l.eventName,(e=>e.detail));class d extends CustomEvent{constructor(e){super(d.eventName,{detail:new o(e),bubbles:!0,composed:!0})}}d.eventName="dxbl-upload.uploadprogress",s.register(d.eventName,(e=>e.detail));class u extends CustomEvent{constructor(e){super(u.eventName,{detail:new r(e),bubbles:!0,composed:!0})}}u.eventName="dxbl-upload.customizeformdata",s.register(u.eventName,(e=>e.detail));var h,c;!function(e){e[e.Instant=0]="Instant",e[e.OnButtonClick=1]="OnButtonClick"}(h||(h={})),function(e){e[e.WaitingStart=0]="WaitingStart",e[e.PendingUpload=1]="PendingUpload",e[e.Uploading=2]="Uploading",e[e.Paused=3]="Paused",e[e.Complete=4]="Complete",e[e.Canceled=5]="Canceled",e[e.Error=6]="Error",e[e.Removing=7]="Removing"}(c||(c={}));class p{constructor(e,t,s=null){this.file=e,this.action=t,this.newReloadedFile=s}}class m{constructor(){this.guids=[],this.actions=[],this.reloadedFileGuids=[]}}class g{constructor(e){this.FileName=e.fileInfo.name,this.FileSize=e.fileInfo.size,this.FileType=e.fileInfo.type,this.LastModified=e.fileInfo.lastModified,this.FileGuid=e.fileInfo.guid,this.Index=e.chunkIndex,this.TotalCount=e.totalChunkCount}}class f{constructor(e,t,s){this._value=e,this._status=s.uploadMode===h.Instant?c.PendingUpload:c.WaitingStart,this._chunkIndex=0,this._loadedBytes=0,this._totalChunkCount=0,this._isFileExtensionValid=f.validateFileExtension(e,s),this._isMinSizeValid=f.validateMinFileSize(e,s),this._isMaxSizeValid=f.validateMaxFileSize(e,s),this._fileInfo={name:e.name,size:e.size,type:e.type,lastModified:1e4*e.lastModified+621355968e9,guid:t},this._request=null,this._onLoadStart=null,this._onProgress=null,this._onAbort=null,this._onPause=null,this._onError=null,this._onLoadEnd=null,this.isValid()||(this._status=c.Error)}get value(){return this._value}get status(){return this._status}set status(e){this._status=e}get chunkIndex(){return this._chunkIndex}set chunkIndex(e){this._chunkIndex=e}get loadedBytes(){return this._loadedBytes}set loadedBytes(e){this._loadedBytes=e}get totalChunkCount(){return this._totalChunkCount}set totalChunkCount(e){this._totalChunkCount=e}get isFileExtensionValid(){return this._isFileExtensionValid}get isMinSizeValid(){return this._isMinSizeValid}get isMaxSizeValid(){return this._isMaxSizeValid}get fileInfo(){return this._fileInfo}get request(){return this._request}set request(e){this._request=e}get onLoadStart(){return this._onLoadStart}set onLoadStart(e){this._onLoadStart=e}get onProgress(){return this._onProgress}set onProgress(e){this._onProgress=e}get onAbort(){return this._onAbort}set onAbort(e){this._onAbort=e}get onError(){return this._onError}set onError(e){this._onError=e}get onLoadEnd(){return this._onLoadEnd}set onLoadEnd(e){this._onLoadEnd=e}isValid(){return this.isFileExtensionValid&&this.isMaxSizeValid&&this.isMinSizeValid}isUploadComplete(){return this.loadedBytes>=this.fileInfo.size}loadStart(){this.status!==c.Uploading&&(this.status=c.Uploading,this.onLoadStart&&this.onLoadStart.call(this))}progress(){this.onProgress&&this.onProgress.call(this)}loadEnd(){this.isUploadComplete()&&(this.status=c.Complete,this.onLoadEnd&&this.onLoadEnd.call(this))}abort(e=!0){this.status!==c.Canceled&&(this.status=c.Canceled,this.request&&this.request.abort(),e&&this.onAbort&&this.onAbort.call(this))}error(e){this.status=c.Error,this.onError&&this.onError.call(this,e)}static validateFileExtension(e,t){const s=t.allowedFileExtensions,i=e.name.substring(e.name.lastIndexOf(".")).toLowerCase();if(0===s.length)return!0;for(let e=0;e<s.length;e++)if(i===s[e].toLowerCase())return!0;return!1}static validateMinFileSize(e,t){const s=t.minFileSize;return!(s>0)||e.size>=s}static validateMaxFileSize(e,t){const s=t.maxFileSize;return!(s>0)||e.size<=s}}class S{constructor(e){this.control=e,this.requestMetadata=null}customizeFormData(e){this.control.dispatchEvent(new u(e))}}class F extends S{constructor(e){super(e)}upload(e,t,s,i){if(!e)return;e.totalChunkCount||(e.chunkIndex=0,e.totalChunkCount=F.calculateTotalChunkCount(e.fileInfo.size,t));const a=t.chunkSize*e.chunkIndex,o=e.value.slice(a,a+t.chunkSize);this.requestMetadata={formData:new FormData,request:t,file:e,loadEnd:i},this.createFormData(t.name,o,e,s)}createFormData(e,t,s,i){var a,o;const r=new g(s);null===(a=this.requestMetadata)||void 0===a||a.formData.append(e,t),null===(o=this.requestMetadata)||void 0===o||o.formData.append("chunkMetadata",JSON.stringify(r)),this.control.customizeFormData||i||(i={}),i?this.onCustomizeChunkMetadataResponse(i):this.customizeFormData(r)}onCustomizeChunkMetadataResponse(e){if(null==this.requestMetadata)return;const{formData:t,request:s,file:i,loadEnd:a}=this.requestMetadata;if(i.status!==c.Paused&&i.status!==c.Canceled){for(const s in e)if(Object.prototype.hasOwnProperty.call(e,s)){const i=e[s];t.append(s,i instanceof Object?JSON.stringify(i):i)}for(const e in s.requestData)Object.prototype.hasOwnProperty.call(s.requestData,e)&&t.append(e,s.requestData[e]);i.request=b.sendRequest(t,{crossDomain:!1,url:s.uploadUrl,method:"POST",headers:s.requestHeaders,onAbort:()=>{i.abort()},onProgress:()=>{},onError:e=>{e.target&&i.error(e.target)},onLoadStart:()=>{i.loadStart()},onLoad:e=>{if(e.target)if(200===e.target.status){const e=t.get(s.name);i.chunkIndex++,i.loadedBytes+=e.size,i.progress(),a(i)}else i.error(e.target)},onLoadEnd:null})}}static calculateTotalChunkCount(e,t){let s=Math.trunc(e/t.chunkSize);return e%t.chunkSize>0&&s++,s}}class C extends S{constructor(e){super(e)}upload(e,t,s,i){e&&(this.requestMetadata={formData:new FormData,request:t,file:e,loadEnd:i},this.createFormData(t.name,e,s))}createFormData(e,t,s){var i;null===(i=this.requestMetadata)||void 0===i||i.formData.append(e,t.value),this.onCustomizeChunkMetadataResponse(s||{})}onCustomizeChunkMetadataResponse(e){if(null==this.requestMetadata)return;const{formData:t,request:s,file:i,loadEnd:a}=this.requestMetadata;for(const e in s.requestData)Object.prototype.hasOwnProperty.call(s.requestData,e)&&t.append(e,s.requestData[e]);let o=!1;i.request=b.sendRequest(t,{url:s.uploadUrl,method:"POST",headers:s.requestHeaders,crossDomain:!1,onProgress:e=>{o=!0,i.loadedBytes=e.loaded>i.fileInfo.size?i.fileInfo.size:e.loaded,i.progress()},onAbort:e=>{i.abort()},onError:e=>{e.target&&i.error(e.target)},onLoadStart:e=>{i.loadStart()},onLoad:e=>{e.target&&(200===e.target.status?(o||(i.loadedBytes=i.fileInfo.size,i.progress()),a(i,e)):i.error(e.target))},onLoadEnd:null})}}class b{static sendRequest(e,t){const s=new XMLHttpRequest;t.crossDomain=b.isCrossDomain(t.url);const i=b.getRequestHeaders(t);s.open(t.method,t.url,!0),t.onLoadStart&&(s.upload.onloadstart=t.onLoadStart),t.onLoad&&(s.onload=t.onLoad),t.onLoadEnd&&(s.upload.onloadend=t.onLoadEnd),t.onProgress&&(s.upload.onprogress=t.onProgress),t.onError&&(s.upload.onerror=t.onError),t.onAbort&&(s.upload.onabort=t.onAbort);for(const e in i)Object.prototype.hasOwnProperty.call(i,e)&&i[e]&&s.setRequestHeader(e,i[e]);return s.send(e),s}static getRequestHeaders(e){const t=e.headers||{};return t.Accept=t.Accept||b.getAcceptHeader(),e.crossDomain||t["X-Requested-With"]||(t["X-Requested-With"]="XMLHttpRequest"),t}static getAcceptHeader(){return"*/*"}static isCrossDomain(e){let t=!1;const s=document.createElement("a"),i=document.createElement("a");s.href=window.location.href;try{i.href=e,i.href=i.href,t=s.protocol+"//"+s.host!=i.protocol+"//"+i.host}catch(e){t=!0}return t}}class v{constructor(e){this.control=e,this.state=new I,this.indexMap=new Map,this.dispatchTimerId=-1,this.idleTimerId=-1}dispatch(e,t,s=null){const i=this.getFileIndex(t),a=new _(i,e,t.loadedBytes,t.status);this.state.progressInfos.push(a),s&&this.state.errors.push(s),this.tryPerformDispatch()}forceDelayedDispatch(){-1!==this.dispatchTimerId&&clearTimeout(this.dispatchTimerId),this.performDispatch()}tryPerformDispatch(){if(-1===this.dispatchTimerId){let e=50;-1!==this.idleTimerId&&(clearTimeout(this.idleTimerId),this.idleTimerId=-1,e=200),this.dispatchTimerId=setTimeout((()=>this.performDispatch()),e)}}performDispatch(){this.dispatchTimerId=-1,this.control.dispatchEvent(new d(this.state)),this.state=new I,this.indexMap.clear(),this.idleTimerId=setTimeout((()=>{this.idleTimerId=-1}),1e3)}getFileIndex(e){let t=this.indexMap.get(e.fileInfo.guid);return void 0!==t||(t=this.state.fileGuids.length,this.state.fileGuids.push(e.fileInfo.guid),this.indexMap.set(e.fileInfo.guid,t)),t}}class I{constructor(){this.fileGuids=[],this.progressInfos=[],this.errors=[]}}class _{constructor(e,t,s,i){this.index=e,this.type=t,this.loaded=s,this.status=i}}var x;!function(e){e[e.Started=0]="Started",e[e.Progress=1]="Progress",e[e.Uploaded=2]="Uploaded",e[e.Aborted=3]="Aborted",e[e.Error=4]="Error"}(x||(x={}));class z extends t{constructor(){super(),this.onInputChangeHandler=this.onFileInputChange.bind(this),this.onSelectButtonClickHandler=this.onSelectButtonClick.bind(this),this.onFilesDropHandler=this.onFilesDrop.bind(this),this.onFilesDragOverHandler=this.onFilesDragOver.bind(this),this.onFilesDragLeaveHandler=this.onFilesDragLeave.bind(this),this._acceptedFileTypes=null,this._allowedFileExtensions=[],this._externalSelectButtonCssSelector="",this._chunkSize=0,this._dragOverClassName="",this._dropZoneCssSelector="",this._maxFileSize=0,this._minFileSize=0,this._multiple=!1,this._uploadMode=h.Instant,this._customizeFormData=!1,this.files=new Map,this.uploaders=new Map,this.progressDispatcher=new v(this)}initializeComponent(){super.initializeComponent(),this.initEvents(),this.prepareInputElement()}get acceptedFileTypes(){return this._acceptedFileTypes}set acceptedFileTypes(e){this._acceptedFileTypes=e}get allowedFileExtensions(){return this._allowedFileExtensions}set allowedFileExtensions(e){this._allowedFileExtensions=e}get externalSelectButtonCssSelector(){return this._externalSelectButtonCssSelector}set externalSelectButtonCssSelector(e){this._externalSelectButtonCssSelector=e}get chunkSize(){return this._chunkSize}set chunkSize(e){this._chunkSize=e}get dragOverClassName(){return this._dragOverClassName}set dragOverClassName(e){this._dragOverClassName=e}get dropZoneCssSelector(){return this._dropZoneCssSelector}set dropZoneCssSelector(e){this._dropZoneCssSelector=e}get maxFileSize(){return this._maxFileSize}set maxFileSize(e){this._maxFileSize=e}get minFileSize(){return this._minFileSize}set minFileSize(e){this._minFileSize=e}get multiple(){return this._multiple}set multiple(e){this._multiple=e}get uploadMode(){return this._uploadMode}set uploadMode(e){this._uploadMode=e}get customizeFormData(){return this._customizeFormData}set customizeFormData(e){this._customizeFormData=e}getFileInput(){return this.querySelector("input")}getSelectButton(){return this.externalSelectButtonCssSelector?document.querySelector(this.externalSelectButtonCssSelector):this.querySelector(".dxuc-select-button")}getDropZoneContainer(){return this.dropZoneCssSelector?document.querySelector(this.dropZoneCssSelector):null}initEvents(){var e;this.getFileInput().addEventListener("change",this.onInputChangeHandler),null===(e=this.getSelectButton())||void 0===e||e.addEventListener("click",this.onSelectButtonClickHandler);const t=this.getDropZoneContainer();t&&(t.addEventListener("drop",this.onFilesDropHandler),t.addEventListener("dragover",this.onFilesDragOverHandler),t.addEventListener("dragleave",this.onFilesDragLeaveHandler))}prepareInputElement(){const e=this.getFileInput();this.multiple&&e.setAttribute("multiple",""),this.acceptedFileTypes&&e.setAttribute("accept",this.acceptedFileTypes.join(","))}onFileInputChange(e){this.addFiles(this.createFileItems(this.getFileInput().files)),this.getFileInput().value=""}onSelectButtonClick(e){this.getFileInput().click()}onFilesDrop(e){e.preventDefault(),this.addFiles(this.createFileItems(this.getFileFromDataTransfer(e.dataTransfer))),this.onFilesDragLeave(e)}onFilesDragOver(t){this.dragOverClassName&&t.srcElement&&e.addClassName(t.srcElement,this.dragOverClassName),t.preventDefault()}onFilesDragLeave(t){this.dragOverClassName&&e.removeClassName(t.srcElement,this.dragOverClassName)}createFileItems(e){if(!e)return[];const t=[],s=this.getAllowedFileTypes();for(let i=0,a=e[i];a;i++,a=e[i]){const o=new f(a,this.getUUID4(),this);o.isValid()&&s&&!this.isFileTypeAllowed(e[i],s)||t.push(o)}return t}isFileTypeAllowed(e,t){return t.some((function(t){if("."===t[0]){if(t=t.replace(".","\\."),e.name.match(new RegExp(t+"$","i")))return!0}else if(t=t.replace("*",""),e.type.match(new RegExp(t,"i")))return!0}))}addFiles(e){0!==e.length&&(e.forEach((e=>this.files.set(e.fileInfo.guid,e))),this.raiseFilesAddedByParts(e))}raiseFilesAddedByParts(e){if(e.length<=100)this.filesAdded(e);else{let t=0,s=100;do{const i=e.slice(t,s);this.filesAdded(i),t+=100,s=Math.min(t+100,e.length)}while(t<e.length)}}getFileFromDataTransfer(e){const t=[];if(e)if(e.items){for(let s=0,i=e.items[s];i;s++,i=e.items[s])if("file"===i.kind){const e=i.getAsFile();e&&t.push(e)}}else for(let s=0,i=e.files[s];i;s++,i=e.files[s])t.push(i);return this.multiple?t:[t[0]]}getFileInfosCollection(e){return e.map((e=>this.createFileViewInfo(e)))}createFileViewInfo(e){return{name:e.fileInfo.name,size:e.fileInfo.size,type:e.fileInfo.type,lastModified:e.fileInfo.lastModified,guid:e.fileInfo.guid,loadedBytes:e.loadedBytes,status:e.status,isFileExtensionValid:e.isFileExtensionValid,isMinSizeValid:e.isMinSizeValid,isMaxSizeValid:e.isMaxSizeValid}}getAllowedFileTypes(){return this.acceptedFileTypes&&this.acceptedFileTypes.length>0?this.acceptedFileTypes.map((e=>e.trim())):null}getUUID4(){const e=new Uint8Array(16);crypto.getRandomValues(e),e[8]&=63,e[8]|=128,e[6]&=15,e[6]|=64;let t=0;return"XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX".replace(/XX/g,(()=>e[t++].toString(16).padStart(2,"0")))}onUploadStartCallback(e,t){const{guid:s,requestJSOptions:i}=e,a=this.files.get(s);a&&(this.attachEventsToFileItem(a),i?i.uploadUrl?this.startUpload(a,i,t.customData||{}):a.error(new EventTarget):a.abort())}startUpload(e,t,s){e.status=c.PendingUpload;const i=this.chunkSize>0?new F(this):new C(this);this.uploaders.set(e.fileInfo.guid,i),i.upload(e,t,s,(e=>{e.loadEnd(),e.isUploadComplete()||e.status!==c.Uploading||this.startUpload(e,t,null)}))}reloadFile(e){const t=this.createFileItems([e.value])[0];return t.status=c.PendingUpload,this.files=z.replaceFileInFilesMap(this.files,e.fileInfo.guid,t),t}static replaceFileInFilesMap(e,t,s){const i=new Map;for(const a of e.values()){const e=a.fileInfo.guid===t?s:a;i.set(e.fileInfo.guid,e)}return i}attachEventsToFileItem(e){e.onLoadStart=()=>{this.fileUploadStarted(e)},e.onProgress=()=>{this.fileProgress(e)},e.onAbort=()=>{this.fileUploadAborted(e)},e.onError=t=>{this.fileUploadError(e,t.status,t.statusText,t.responseText)},e.onLoadEnd=()=>{this.fileUploaded(e)}}filesAdded(e){this.dispatchEvent(new n(this.getFileInfosCollection(e)))}fileUploadStarted(e){this.progressDispatcher.dispatch(x.Started,e)}fileUploaded(e){this.progressDispatcher.dispatch(x.Uploaded,e)}fileUploadAborted(e){this.progressDispatcher.dispatch(x.Aborted,e)}fileProgress(e){this.progressDispatcher.dispatch(x.Progress,e)}fileUploadError(e,t,s,i){this.progressDispatcher.dispatch(x.Error,e,{status:t,statusText:s,responseText:i})}requestAction(e){this.dispatchEvent(new l(e))}processFileStates(e){const t=[];if(this.updateFileStates(e,t)){const e=this.createActionRequest(t);this.progressDispatcher.forceDelayedDispatch(),this.requestAction(e)}}updateFileStates(e,t){let s=!1;for(const i in e){if(!Object.prototype.hasOwnProperty.call(e,i))continue;const a=this.files.get(i);if(a&&a.status!==e[i]){const o=this.changeStatus(a,e[i]);t.push(o),s=!0}}return s}createActionRequest(e){const t=new m,s=new Map;return e.forEach((e=>{const i=e.file.fileInfo.guid;let a=s.get(i);void 0===a&&(a=t.guids.length,t.guids.push(i),s.set(i,a)),t.actions.push(e.action,a),e.action===c.PendingUpload&&e.newReloadedFile&&t.reloadedFileGuids.push(e.newReloadedFile.fileInfo.guid)})),t}changeStatus(e,t){switch(t){case c.PendingUpload:{const t=this.reloadFile(e);return new p(e,c.PendingUpload,t)}case c.Paused:e.status=c.Paused;break;case c.Canceled:e.abort(!1);break;case c.Removing:this.files.delete(e.fileInfo.guid);break;default:throw new Error("Status not supported.")}return new p(e,t)}onCustomizeFormDataCallback(e){var t;const s=e.fileGuid;null===(t=this.uploaders.get(s))||void 0===t||t.onCustomizeChunkMetadataResponse(e.customData),this.uploaders.delete(s)}static get observedAttributes(){return["accepted-file-types","allowed-file-extensions","external-select-button-css-selector","chunk-size","max-file-size","min-file-size","multiple","upload-mode","drag-over-class-name","drop-zone-css-selector","apply-file-states","customize-form-data","trigger-show-file-selector-dialog"]}attributeChangedCallback(e,t,s){var i;switch(e){case"accepted-file-types":this.acceptedFileTypes=JSON.parse(s);break;case"allowed-file-extensions":this.allowedFileExtensions=JSON.parse(s);break;case"external-select-button-css-selector":this.externalSelectButtonCssSelector=s;break;case"chunk-size":this.chunkSize=Number(s);break;case"max-file-size":this.maxFileSize=Number(s);break;case"min-file-size":this.minFileSize=Number(s);break;case"multiple":this.multiple=null!==s;break;case"upload-mode":this.uploadMode=Number(s);break;case"drag-over-class-name":this.dragOverClassName=s;break;case"drop-zone-css-selector":this.dropZoneCssSelector=s;break;case"customize-form-data":this.customizeFormData=null!==s;break;case"apply-file-states":this.processFileStates(JSON.parse(s));break;case"trigger-show-file-selector-dialog":JSON.parse(s)&&(null===(i=this.getFileInput())||void 0===i||i.click())}}}customElements.define("dxbl-upload",z),customElements.define("dxbl-uploaded-file",class extends t{constructor(){super(),this._control=null,this._lastUploadStartOptions=null}initializeComponent(){super.initializeComponent(),this._control=e.getParentByTagName(this,"DXBL-UPLOAD"),this.startUpload(this.uploadStartOptions,this.customDataOptions)}get uploadStartOptions(){const e=this.getAttribute("upload-start-options")||"";return JSON.parse(e)}get customDataOptions(){const e=this.getAttribute("custom-form-data-options")||"";return JSON.parse(e)}startUpload(e,t){this._control&&e&&t&&this._control.onUploadStartCallback(e,t)}static get observedAttributes(){return["upload-start-options","custom-form-data-options"]}attributeChangedCallback(e,t,s){var i;if(this._control)switch(e){case"upload-start-options":this._lastUploadStartOptions=this.uploadStartOptions;break;case"custom-form-data-options":{const e=JSON.parse(s);if(e)if(this._lastUploadStartOptions){const t=this._lastUploadStartOptions;this._lastUploadStartOptions=null,this.startUpload(t,e)}else null===(i=this._control)||void 0===i||i.onCustomizeFormDataCallback(e);break}}}});const E={loadModule:function(){}};export{z as DxUpload,E as default};
