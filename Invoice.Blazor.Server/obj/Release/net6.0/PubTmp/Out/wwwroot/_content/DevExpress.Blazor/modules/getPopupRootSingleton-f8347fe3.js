import{_ as e}from"./_tslib-6e8ca86b.js";import{BranchCreatedEvent as t,BranchUpdatedEvent as s,BranchRemovedEvent as n,BranchActivatedEvent as i,BranchRefreshedEvent as r}from"./branch-2ea85171.js";import{L as d,c as o}from"./capturemanager-91fa2b2d.js";import{E as a}from"./eventhelper-8570b930.js";import{R as h}from"./rafaction-bba7928b.js";import{D as l}from"./data-qa-utils-8be7c726.js";import{s as c}from"./lit-element-b0a6fcba.js";import{e as p}from"./property-d3853089.js";import{n as u}from"./custom-element-bd7061f2.js";var m;!function(e){e.Modal="modal",e.DropDown="dropdown",e.Flyout="flyout",e.Window="window",e.Root="root"}(m||(m={}));class b{constructor(e,t,s){this._children=new Set,this._id=e,this._parentId=t,this._type=s}get type(){return this._type}get children(){return Array.from(this._children)}get hasChildren(){return this._children.size>0}get id(){return this._id}add(e){this._children.add(e)}remove(e){this._children.delete(e)}}class g{constructor(){this.idToNode=new Map,this.idToParentId=new Map,this._roots=[],this.idToNode.set(g.root,new b(g.root,g.root,m.Root))}get roots(){return this._roots}add(e,t,s){const n=new b(e,t=null!=t?t:g.root,s);this.idToParentId.set(e,t),this.idToNode.set(e,n);this.idToNode.get(t).add(n),t===g.root&&this._roots.push(e)}remove(e){if(!this.idToNode.has(e))return;const t=this.idToParentId.get(e),s=this.idToNode.get(t),n=this.idToNode.get(e);this.idToParentId.delete(e),this.idToNode.delete(e),s.remove(n),t===g.root&&(this._roots=this._roots.splice(this.roots.indexOf(e),1))}inTree(e){return this.idToNode.has(e)}getBranch(e){const t=[e];let s=this.idToParentId.get(e);for(;s&&s!==g.root;)t.push(s),s=this.idToParentId.get(s);return t}getParentId(e){return this.idToParentId.get(e)}getBranchNode(e){var t;return null!==(t=this.idToNode.get(e))&&void 0!==t?t:null}findRoot(e){let t=e;for(;;){const e=this.idToParentId.get(t);if(e===g.root)return t;t=e}}}g.baseIndex=1050,g.root="";class v{constructor(e){this._children=new Array,this._index=0,this.branchNode=e}get type(){return this.branchNode.type}get index(){return this._index}set index(e){this._index=e}get children(){return this._children}get hasChildren(){return this._children.length>0}get id(){return this.branchNode.id}add(e){this._children.push(e)}remove(e){this._children=this._children.filter((t=>t!==e))}peek(){return this._children[this._children.length-1]}activate(e){return this.peek()!==e&&(this.remove(e),this.add(e),!0)}}const f=new g,N=new class{constructor(){this.idToNode=new Map,this.rootNode=new v(f.getBranchNode("")),this.idToNode.set("",this.rootNode)}getIndex(e){const t=this.idToNode.get(e);return t?t.index:0}register(e){const t=f.findRoot(e),s=f.getBranchNode(e),n=new v(s);if(this.idToNode.set(e,n),e===t)this.rootNode.add(n);else{const t=f.getParentId(e);this.idToNode.get(t).add(n)}this.refresh()}unregister(e){var t;const s=null!==(t=this.idToNode.get(e))&&void 0!==t?t:null;if(!s)return;const n=f.getParentId(s.id);this.idToNode.get(n).remove(s);for(const t of this.iterateBranch(e))this.idToNode.delete(t);this.idToNode.delete(e),this.refresh()}activate(e){var t,s,n;let i=null!==(t=this.idToNode.get(e))&&void 0!==t?t:null;if(!i)return!1;let r=!1;for(;i;){const e=f.getParentId(i.id),t=null!==(s=this.idToNode.get(e))&&void 0!==s?s:null;r=r||null!==(n=null==t?void 0:t.activate(i))&&void 0!==n&&n,i=t}return r}iterateBranch(e){let t=new Array;const s=this.idToNode.get(e);if(!(null==s?void 0:s.hasChildren))return t;for(const e of s.children)t.push(e.id),t=t.concat(this.iterateBranch(e.id));return t.sort(((e,t)=>this.idToNode.get(t).index-this.idToNode.get(e).index))}refresh(){let e=!1,t=g.baseIndex;for(const s in this.rootNode.children){const n=this.rootNode.children[s];e?t+=this.incrementByType(n.type):e=!0,t=this.calculateZIndices(n,t)}}calculateZIndices(e,t){if(e.index=t,e.hasChildren)for(const s of e.children)t+=this.incrementByType(s.type),t=this.calculateZIndices(s,t);return t}incrementByType(e){switch(e){case m.Flyout:case m.DropDown:return 10;case m.Modal:return 100}return 10}};class I{constructor(e){this.elements=e}}class _ extends CustomEvent{constructor(e){super(_.eventName,{detail:e,bubbles:!0})}}_.eventName="dxbl-portable-elements-changed";let x=class extends c{constructor(){super(...arguments),this._portable=null,this._elementsPorted=!1,this.slotChangedHandler=this.handleSlotChange.bind(this)}get portable(){return this._portable}createRenderRoot(){const e=super.createRenderRoot(),t=document.createElement("slot");return e.appendChild(t),t.addEventListener("slotchange",this.slotChangedHandler),e}handleSlotChange(e){const t=e.target.assignedNodes();this._elementsPorted&&0===t.length||(this.assignElements(t),this._elementsPorted=!0)}assignElements(e){this._portable=e,this.raiseElementsChanged(e)}connectedCallback(){super.connectedCallback(),l.setLoaded(this),H().assign(this)}disconnectedCallback(){super.disconnectedCallback(),H().release(this),l.removeLoaded(this)}raiseElementsChanged(e){const t=new _(new I(e));this.dispatchEvent(t)}updated(e){if(!this.branchId)throw new Error("branch-id must be specified")}};function E(){}e([p({type:String,attribute:"branch-id"})],x.prototype,"branchId",void 0),x=e([u("dxbl-portal")],x);const T=Object.freeze({__proto__:null,dxPortalTagName:"dxbl-portal",PortableElementsChangedEvent:_,get DxPortal(){return x},init:E,default:{init:E,DxPortal:x,dxPortalTagName:"dxbl-portal"}});let C=class extends c{constructor(){super(...arguments),this._portal=null,this.elements=null,this.elementsChangedHandler=this.handleElementsChanged.bind(this),this.zIndex=0}createRenderRoot(){return this}get portal(){return this._portal}setPortal(e){this.unsubscribe(),this._portal=e,this.subscribe(),this.updateElements(this.elements,e.portable)}connectedCallback(){super.connectedCallback(),this.subscribe()}subscribe(){this.portal&&this.portal.addEventListener(_.eventName,this.elementsChangedHandler)}unsubscribe(){this.portal&&this.portal.removeEventListener(_.eventName,this.elementsChangedHandler)}disconnectedCallback(){super.disconnectedCallback(),this.unsubscribe()}handleElementsChanged(e){this.updateElements(this.elements,e.detail.elements)}updateElements(e,t){e&&e.forEach((e=>this.removeChild(e))),this.elements=t,t&&this.append(...t)}updated(e){e.has("zIndex")&&(this.style.zIndex=String(this.zIndex))}};e([p({type:Number,reflect:!1})],C.prototype,"zIndex",void 0),C=e([u("dxbl-popup-cell")],C);const P="dxbl-popup-root",w=document.createElement("template");w.innerHTML='<dxbl-popup-cell class="dxbl-popup-cell" />';let y=class extends c{constructor(){super(...arguments),this.activateLocker=new d,this.portalsMapping=new Map,this.portals=new Map,this.rafAction=new h,this.focusInHandler=this.handleFocusIn.bind(this),this.branchCreatedHandler=this.handleBranchCreated.bind(this),this.branchUpdatedHandler=this.handleBranchUpdated.bind(this),this.branchRemovedHandler=this.handleBranchRemoved.bind(this),this.branchActivatedHandler=this.handleBranchActivated.bind(this),this.branchRefreshedHandler=this.handleBranchRefreshed.bind(this)}createRenderRoot(){return this}assign(e){if(this.portals.has(e))return;const t=this.selectTemplate(e);this.appendChild(t);const s=this.children[this.children.length-1];s.setPortal(e),this.portalsMapping.set(e.branchId,e),this.portals.set(e,s)}release(e){const t=this.portals.get(e);this.portalsMapping.delete(e.branchId),this.portals.delete(e),this.removeChild(t)}connectedCallback(){super.connectedCallback(),this.tabIndex=0,this.addEventListener("focusin",this.focusInHandler,{capture:!0}),this.addEventListener(t.eventName,this.branchCreatedHandler),this.addEventListener(s.eventName,this.branchUpdatedHandler),this.addEventListener(n.eventName,this.branchRemovedHandler),this.addEventListener(i.eventName,this.branchActivatedHandler),this.addEventListener(r.eventName,this.branchRefreshedHandler)}disconnectedCallback(){super.disconnectedCallback(),this.removeEventListener("focusin",this.focusInHandler),this.removeEventListener(t.eventName,this.branchCreatedHandler),this.removeEventListener(s.eventName,this.branchUpdatedHandler),this.removeEventListener(n.eventName,this.branchRemovedHandler),this.removeEventListener(i.eventName,this.branchActivatedHandler),this.removeEventListener(r.eventName,this.branchRefreshedHandler)}handleFocusIn(e){this.rafAction.cancel();e.target===this&&(a.markHandled(e),this.rafAction.execute((()=>this.blur())))}handleBranchCreated(e){f.add(e.detail.id,e.detail.parentId,e.detail.type),this.assignZIndices()}handleBranchUpdated(e){f.remove(e.detail.id),f.add(e.detail.id,e.detail.parentId,e.detail.type),this.assignZIndices()}handleBranchRemoved(e){f.remove(e.detail.id),this.assignZIndices()}handleBranchActivated(e){const t=e.detail.id;if(!N.activate(t)){const e=this.portalsMapping.get(t);return o.capture(e.popupBase),void this.assignZIndices()}const s=[];for(const e of N.iterateBranch(t)){const n=this.portalsMapping.get(e);if(s.push(n.popup),e===t)break}if(s.length>0)s.forEach((e=>o.releaseCapture(e))),s.forEach((e=>o.capture(e)));else{const e=this.portalsMapping.get(t);o.capture(e.popupBase)}this.assignZIndices()}handleBranchRefreshed(e){this.assignZIndices()}assignZIndices(){N.refresh();for(const e of this.portals.keys()){const t=e.branchId;this.portals.get(e).zIndex=N.getIndex(t)}}getPopup(e){const t=this.portalsMapping.get(e);return null==t?void 0:t.popupBase}selectTemplate(e){return w.content.cloneNode(!0)}};y=e([u("dxbl-popup-root")],y);const B=new class{constructor(){this._rootElementPromise=new Promise(((e,t)=>{const s="dxbl-popup-root";customElements.whenDefined(s).then((()=>{const t=document.createElement(s);document.body.appendChild(t),e(t)}))}))}assign(e){this._rootElementPromise.then((t=>t.assign(e)))}getPopup(e){return this._rootElementPromise.then((t=>t.getPopup(e)))}release(e){this._rootElementPromise.then((t=>t.release(e)))}};function H(){return B}export{m as B,x as D,_ as P,f as b,P as d,H as g,T as p,N as v};
